#!/bin/bash

set -e  # Exit on error

cd "$(dirname "$0")"

# Run Playwright tests
echo "Running Playwright tests..."
mvn clean test -Dtest=com.runner.TestSuiteRunner -Dsurefire.failIfNoTests=false -DtestFailureIgnore=true

# Verify if test results exist
if [ ! -d "allure-results" ] || [ "$(find allure-results -type f | wc -l)" -eq 0 ]; then
    echo "‚ùå Error: No Allure test results found!"
    exit 1
fi

# Check if Allure CLI is installed
if ! which allure > /dev/null 2>&1; then
    echo "‚ùå Error: Allure CLI is not installed or not in PATH. Please install it."
    exit 1
fi

# Generate Allure report
echo "Generating Allure report..."
allure generate --clean allure-results -o allure-report

# Get GitHub Actions Job URL
GITHUB_RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

# Ensure application.properties exists before modifying
if [ ! -f "src/main/resources/application.properties" ]; then
    echo "‚ùå Error: application.properties file not found!"
    exit 1
fi

# Replace {REPORT_URL} placeholder in application.properties (cross-platform)
if [[ "$OSTYPE" == "darwin"* ]]; then
    sed -i '' "s|{REPORT_URL}|$GITHUB_RUN_URL|g" src/main/resources/application.properties
else
    sed -i "s|{REPORT_URL}|$GITHUB_RUN_URL|g" src/main/resources/application.properties
fi

# Send email using EmailSender class from com.utils package
echo "Sending email with report link: $GITHUB_RUN_URL"
mvn exec:java -Dexec.mainClass="com.utils.EmailSender" -Dexec.classpathScope=test -Dexec.args="$GITHUB_RUN_URL"

echo "‚úÖ Test execution and reporting completed!"

# Deploy Allure Report to GitHub Pages
echo "üöÄ Deploying Allure report to GitHub Pages..."

# Ensure gh-pages branch exists
if [ ! -d "gh-pages" ]; then
  git clone --branch=gh-pages https://github.com/${GITHUB_REPOSITORY}.git gh-pages
fi

# Copy the new Allure report
rm -rf gh-pages/*
cp -r allure-report/* gh-pages/

# Commit and push changes
cd gh-pages
git config --global user.email "github-actions@github.com"
git config --global user.name "GitHub Actions"
git add .
git commit -m "üöÄ Updated Allure Report [$(date)]" || echo "No changes to commit"
git push origin gh-pages

echo "‚úÖ Allure report deployed: https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY}/"
